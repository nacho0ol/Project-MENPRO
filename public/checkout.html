<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Olivia Meat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* CSS SAMA SEPERTI SEBELUMNYA (TIDAK BERUBAH) */
        body { background-color: #fff; overflow-x: hidden; font-family: 'Poppins', sans-serif; }
        .navbar-checkout { background-color: var(--primary-red); padding: 15px 0; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 100; }
        .checkout-wrapper { display: flex; min-height: calc(100vh - 70px); }
        .left-panel { flex: 1.3; background: #fff; padding: 40px 5%; border-right: 1px solid #e1e1e1; display: flex; flex-direction: column; align-items: center; }
        .form-container { width: 100%; max-width: 520px; text-align: left; }
        .breadcrumb { font-size: 0.85rem; margin-bottom: 25px; color: #666; text-align: left; }
        .breadcrumb a { color: var(--primary-red); text-decoration: none; }
        .breadcrumb span { margin: 0 5px; color: #ccc; }
        .breadcrumb .current { font-weight: 600; color: #333; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 15px; text-align: left; display: block; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; text-align: left; }
        .form-input { width: 100%; padding: 12px 15px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 0.95rem; outline: none; transition: 0.2s; background: #fff; }
        .form-input:focus { border-color: var(--primary-red); box-shadow: 0 0 0 1px var(--primary-red); }
        .payment-box { border: 1px solid #d9d9d9; border-radius: 6px; overflow: hidden; margin-top: 10px; }
        .payment-option { padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid #eee; background: #fff; transition: 0.2s; text-align: left; }
        .payment-option:last-child { border-bottom: none; }
        .payment-option:hover { background: #f9f9f9; }
        .payment-option input { accent-color: var(--primary-red); transform: scale(1.1); }
        .pay-info strong { display: block; font-size: 0.95rem; color: #333; }
        .pay-info small { font-size: 0.8rem; color: #777; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .back-link { text-decoration: none; color: var(--primary-red); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-order { background-color: #8b0000; color: white; padding: 14px 25px; border: none; border-radius: 6px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        .btn-order:hover { background-color: #a50000; }
        .right-panel { flex: 1; background: #fafafa; border-left: 1px solid #e1e1e1; padding: 40px 5%; }
        .summary-inner { max-width: 400px; margin: 0; }
        .order-card { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .img-wrap { position: relative; width: 64px; height: 64px; border: 1px solid #e1e1e1; border-radius: 8px; background: #fff; padding: 2px; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .qty-badge { position: absolute; top: -8px; right: -8px; background: #777; color: white; font-size: 0.75rem; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .item-text h4 { font-size: 0.95rem; color: #333; margin-bottom: 2px; }
        .item-text p { font-size: 0.85rem; color: #777; }
        .item-price { margin-left: auto; font-weight: 600; font-size: 0.95rem; color: #333; }
        .price-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: #555; }
        .total-line { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e1e1e1; align-items: center; }
        .total-label { font-size: 1.1rem; color: #333; }
        .total-val { font-size: 1.3rem; font-weight: 700; color: #333; }
        .currency { font-size: 0.8rem; color: #777; margin-right: 5px; font-weight: 400; }
        @media (max-width: 900px) { .checkout-wrapper { flex-direction: column-reverse; } .left-panel, .right-panel { border: none; padding: 30px 20px; } .right-panel { border-bottom: 1px solid #e1e1e1; } }
    </style>
</head>
<body>

    <nav class="navbar-checkout">
        <div class="container nav-content" style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            <a href="index.html" style="color: white; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; text-decoration: none;">
                <img src="logo.png" alt="Logo" style="height: 35px; background: white; border-radius: 50%; padding: 2px;">
                <span>Olivia Meat</span>
            </a>
            <a href="cart.html" style="color: white; text-decoration: none; font-size: 0.9rem;">
                <i class="fas fa-shopping-basket"></i> Kembali ke Keranjang
            </a>
        </div>
    </nav>

    <div class="checkout-wrapper">
        <div class="left-panel">
            <div class="form-container">
                <div class="breadcrumb">
                    <a href="cart.html">Cart</a>
                    <span><i class="fas fa-chevron-right" style="font-size: 10px;"></i></span>
                    <span class="current">Payment</span>
                </div>

                <form id="checkoutForm" onsubmit="kirimPesanan(event)">
                    <div class="section-title">Pilih Alamat Pengiriman</div>
                    <div class="form-group">
                        <label class="form-label">Alamat Tersimpan</label>
                        <select id="savedAddresses" class="form-input" onchange="selectSavedAddress()">
                            <option value="">-- Gunakan Alamat Baru --</option>
                        </select>
                    </div>
                    
                    <div class="section-title">Data Pemesan</div>
                    <div class="form-group"><label class="form-label">Nama Lengkap (Contact)</label><input type="text" id="nama" class="form-input" placeholder="Masukkan nama Anda" required></div>
                    <div class="form-group"><label class="form-label">Nomor Telepon / WhatsApp (Ship to)</label><input type="tel" id="wa" class="form-input" placeholder="08xxxxxxxxxx" required></div>
                    <div class="form-group"><label class="form-label">Alamat Pengiriman</label><textarea id="alamat" class="form-input" placeholder="Alamat lengkap, patokan, dll" style="min-height: 80px;" required></textarea></div>
                    <input type="checkbox" id="saveInfo"><label for="saveInfo" style="font-size: 0.85rem; color: #666; cursor: pointer;"> Simpan informasi ini sebagai alamat baru</label>
                    <br>
                    <div class="section-title">Metode Pembayaran</div>
                    <div class="payment-box">
                        <label class="payment-option"><input type="radio" name="payment" value="Transfer Bank" checked><div class="pay-info"><strong>Transfer Bank</strong><small>BCA / Mandiri / BRI</small></div></label>
                        <label class="payment-option"><input type="radio" name="payment" value="COD"><div class="pay-info"><strong>COD</strong><small>Bayar tunai saat kurir sampai</small></div></label>
                    </div>
                    <div class="form-actions"><a href="cart.html" class="back-link"><i class="fas fa-chevron-left"></i> Back to Cart</a><button type="submit" class="btn-order">Order Now</button></div>
                </form>
            </div>
        </div>

        <div class="right-panel">
            <div class="summary-inner">
                <div id="itemList"></div>
                <div style="border-top: 1px solid #e1e1e1; padding-top: 20px; margin-top: 20px;">
                    <div class="price-line"><span>Subtotal</span><span id="subTotal" style="font-weight: 500; color: #333;">Rp 0</span></div>
                    <div class="price-line"><span>Shipping</span><span style="font-weight: 500; color: #2ecc71;">Gratis</span></div>
                    <div class="price-line"><span>Biaya Layanan</span><span style="font-weight: 500; color: #333;">Rp 2.000</span></div>
                </div>
                <div class="total-line"><span class="total-label">Total</span><span class="total-val"><span class="currency">IDR</span> <span id="finalTotal">Rp 0</span></span></div>
            </div>
        </div>
    </div>

    <script>
        // 1. Check login terlebih dahulu
        const userData = JSON.parse(localStorage.getItem('user') || '{}');
        if (!userData.idUser && !userData.id) {
            alert('Anda harus login terlebih dahulu untuk checkout');
            window.location.href = 'login.html';
        }

        // 2. Load Cart - FILTER HANYA YANG DIPILIH (selected: true)
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        // Filter hanya item yang dicentang
        cart = cart.filter(item => item.selected !== false);
        
        if (cart.length === 0) { window.location.href = 'index.html'; }

        // Untuk menyimpan data profil user
        let userProfile = {};

        const itemList = document.getElementById('itemList');
        let subTotal = 0;

        cart.forEach(item => {
            let itemTotal = item.price * item.qty;
            subTotal += itemTotal;
            itemList.innerHTML += `
                <div class="order-card">
                    <div class="img-wrap"><img src="${item.img}" alt="${item.name}"><div class="qty-badge">${item.qty}</div></div>
                    <div class="item-text"><h4>${item.name}</h4><p>Pack 500gr</p></div>
                    <div class="item-price">Rp ${itemTotal.toLocaleString('id-ID')}</div>
                </div>`;
        });

        const finalTotal = subTotal + 2000;
        document.getElementById('subTotal').innerText = 'Rp ' + subTotal.toLocaleString('id-ID');
        document.getElementById('finalTotal').innerText = 'Rp ' + finalTotal.toLocaleString('id-ID');

        // 2.5 Fetch user profile saat halaman dibuka
        async function loadUserProfile() {
            try {
                const idUser = userData.idUser || userData.id;
                const response = await fetch(`/api/users/${idUser}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    userProfile = result.data;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // 3. Load saved addresses
        async function loadSavedAddresses() {
            try {
                const idUser = userData.idUser || userData.id;
                const response = await fetch(`/api/users/${idUser}/addresses`);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    const selectBox = document.getElementById('savedAddresses');
                    result.data.forEach(addr => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({
                            nama: addr.namaPenerima,
                            telp: addr.noTelp,
                            alamat: addr.alamat
                        });
                        option.textContent = `${addr.namaPenerima} - ${addr.alamat.substring(0, 40)}...`;
                        selectBox.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
            }
        }

        // 4. Function untuk pilih alamat dari dropdown
        function selectSavedAddress() {
            const selectBox = document.getElementById('savedAddresses');
            const selectedValue = selectBox.value;

            if (selectedValue) {
                const addressData = JSON.parse(selectedValue);
                document.getElementById('nama').value = addressData.nama;
                document.getElementById('wa').value = addressData.telp;
                document.getElementById('alamat').value = addressData.alamat;
            } else {
                document.getElementById('nama').value = '';
                document.getElementById('wa').value = '';
                document.getElementById('alamat').value = '';
            }
        }

        // 5. LOGIKA BARU: Simpan Order ke Database via API & Kirim WA
        async function kirimPesanan(e) {
            e.preventDefault();
            
            try {
                const nama = document.getElementById('nama').value;
                const wa = document.getElementById('wa').value;
                const alamat = document.getElementById('alamat').value;
                const payment = document.querySelector('input[name="payment"]:checked').value;
                const saveAddr = document.getElementById('saveInfo').checked;

                // Gunakan userData yang sudah di-load di atas
                const idUser = userData.idUser || userData.id;

                // Prepare items dari cart untuk API
                const items = cart.map(item => ({
                    idProduk: item.idProduk || item.id || 1,
                    qtyPesanan: parseFloat(item.qty),
                    hargaSatuan: parseFloat(item.price)
                }));

                // Siapkan data order untuk API
                // SEMUA data dari userProfile (data asli profil), bukan dari form input
                // Ini memastikan profile tidak berubah sama sekali saat checkout
                const orderData = {
                    idUser: parseInt(idUser),
                    namaDepan: userProfile.namaDepan || '',
                    namaBelakang: userProfile.namaBelakang || '',
                    no_telp: userProfile.no_telp || '',
                    alamat: userProfile.alamat || '',
                    payment_method: payment,
                    items: items,
                    ongkir: 0 // Gratis ongkir
                };

                // POST ke API
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    // A. Jika checkbox "Simpan alamat" dicentang, simpan ke database
                    if (saveAddr) {
                        try {
                            await fetch(`/api/users/${idUser}/addresses`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    namaPenerima: nama,
                                    noTelp: wa,
                                    alamat: alamat
                                })
                            });
                        } catch (err) {
                            console.error('Error saving address:', err);
                        }
                    }

                    // B. BUAT DATA ORDER UNTUK DISIMPAN KE HISTORY (untuk tampilan lokal)
                    const newOrder = {
                        id: 'ORD-' + result.data.idPemesanan,
                        date: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
                        items: cart,
                        total: result.data.grandTotal,
                        status: 'Menunggu Konfirmasi',
                        payment: payment
                    };

                    // B. AMBIL HISTORY LAMA & GABUNGKAN
                    let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
                    orderHistory.unshift(newOrder);
                    localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

                    // C. HAPUS HANYA ITEM YANG DI-CHECKOUT DARI KERANJANG
                    // Item yang tidak dipilih (selected = false) harus tetap ada di cart
                    let allCart = JSON.parse(localStorage.getItem('cart') || '[]');
                    let remainingCart = allCart.filter(item => !item.selected);
                    if (remainingCart.length > 0) {
                        localStorage.setItem('cart', JSON.stringify(remainingCart));
                    } else {
                        localStorage.removeItem('cart');
                    }

                    // D. KIRIM KE WA
                    let message = `Halo Admin Olivia Meat!%0A%0APesanan Baru (${newOrder.id}):%0A`;
                    cart.forEach(item => { message += `${item.qty}x ${item.name}%0A`; });
                    message += `%0A*Total: Rp ${result.data.grandTotal.toLocaleString('id-ID')}*%0A`;
                    message += `------------------%0A`;
                    message += `Nama: ${nama}%0AHP: ${wa}%0AAlamat: ${alamat}%0APembayaran: ${payment}`;

                    // F. BUKA WA & REDIRECT KE PROFILE
                    window.open(`https://wa.me/6282136656877?text=${message}`, '_blank');
                    alert('✓ Pesanan berhasil dibuat! Data sudah disimpan di database.');
                    window.location.href = 'profile.html';
                } else {
                    alert('❌ Gagal membuat pesanan: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Terjadi kesalahan saat membuat pesanan');
            }
        }

        // Load saved addresses saat halaman terbuka
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile();
            loadSavedAddresses();
        });
    </script>
</body>
</html>