<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Olivia Meat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      /* CSS TAMBAHAN UNTUK PROFILE & HISTORY */
      .sidebar-menu a {
        cursor: pointer;
      }
      .sidebar-menu a.active {
        background-color: #ffeaea;
        color: var(--primary-red);
      }

      /* Tab Content Control */
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Read-Only Profile Display */
      .profile-display {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
      }
      .profile-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 20px;
        margin-bottom: 15px;
        align-items: center;
      }
      .profile-label {
        font-weight: 600;
        color: var(--secondary-navy);
      }
      .profile-value {
        color: #555;
      }

      /* Address List */
      .address-list {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
      }
      .address-card {
        background: white;
        border: 1px solid #e1e1e1;
        border-radius: 10px;
        padding: 15px;
        position: relative;
      }
      .address-card.active {
        border-color: var(--primary-red);
        background: #fff9f9;
      }
      .address-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
      }
      .address-label {
        font-weight: 600;
        color: var(--secondary-navy);
        display: inline-block;
        background: #f0f0f0;
        padding: 3px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
      }
      .address-text {
        color: #555;
        line-height: 1.6;
      }
      .address-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .btn-small {
        padding: 6px 12px;
        font-size: 0.85rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn-edit {
        background: #ffc107;
        color: white;
      }
      .btn-edit:hover {
        background: #e0a800;
      }
      .btn-delete {
        background: #dc3545;
        color: white;
      }
      .btn-delete:hover {
        background: #c82333;
      }
      .btn-primary {
        background: var(--primary-red);
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
      }
      .modal-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--secondary-navy);
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
      }
      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: "Poppins", sans-serif;
        font-size: 0.95rem;
        background: #fdfdfd;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        border-color: var(--primary-red);
        background: #fff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
      }

      .form-group textarea {
        resize: vertical;
      }

      .btn-cancel {
        background: #e9ecef;
        color: #333;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-submit {
        background: var(--primary-red);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-submit:hover {
        background: var(--primary-hover);
      }

      /* Style Kartu History */
      .history-card {
        border: 1px solid #e1e1e1;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background: #fff;
        transition: 0.3s;
      }
      .history-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        align-items: center;
      }
      .order-id {
        font-weight: 700;
        color: var(--secondary-navy);
      }
      .order-date {
        font-size: 0.85rem;
        color: #777;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-success {
        background: #d4edda;
        color: #155724;
      }
      .status-danger {
        background: #f8d7da;
        color: #721c24;
      }

      .history-items {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .h-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #555;
      }

      .history-footer {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .total-label {
        font-size: 0.9rem;
      }
      .total-price {
        font-weight: 700;
        color: var(--primary-red);
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container nav-content">
        <a href="index.html" class="logo"
          ><img src="uploads/LOGO.png" alt="Logo" /><span
            >Olivia Meat N Fresh</span
          ></a
        >
        <div class="nav-links">
          <a href="index.html#katalog">Produk</a>
          <a href="index.html#tentang">Tentang Kami</a>
          <a href="#footer-area">Kontak Kami</a>
        </div>
        <div class="nav-icons">
          <a href="cart.html"><i class="fas fa-shopping-cart"></i></a>
          <a href="profile.html"><i class="fas fa-user"></i></a>
          <a
            href="login.html"
            class="logout-btn"
            onclick="return confirm('Yakin ingin keluar?')"
            ><i class="fas fa-sign-out-alt"></i> Keluar</a
          >
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="dashboard-wrapper">
        <div class="sidebar">
          <div class="user-card">
            <div class="user-avatar"><i class="fas fa-user-circle"></i></div>
            <h4>Halo, User!</h4>
            <p style="font-size: 12px; color: #888">Member Setia</p>
          </div>
          <ul class="sidebar-menu">
            <li>
              <a onclick="switchTab('profile')" id="menu-profile" class="active"
                ><i class="fas fa-user"></i> Data Profil</a
              >
            </li>
            <li>
              <a onclick="switchTab('address')" id="menu-address"
                ><i class="fas fa-map-marked-alt"></i> Alamat Saya</a
              >
            </li>
            <li>
              <a onclick="switchTab('history')" id="menu-history"
                ><i class="fas fa-history"></i> Riwayat Pesanan</a
              >
            </li>
            <li>
              <a href="login.html" style="color: #d9534f"
                ><i class="fas fa-sign-out-alt"></i> Keluar</a
              >
            </li>
          </ul>
        </div>

        <div class="dashboard-content">
          <div id="tab-profile" class="tab-content active">
            <div class="dashboard-header">
              <h2>Data Profil</h2>
              <button
                type="button"
                class="btn-primary"
                onclick="openEditModal()"
              >
                <i class="fas fa-edit"></i> Edit Profil
              </button>
            </div>
            <div class="profile-display">
              <div class="profile-row">
                <div class="profile-label">Nama Lengkap</div>
                <div class="profile-value">
                  <span id="displayNamaDepan">-</span>
                  <span id="displayNamaBelakang">-</span>
                </div>
              </div>
              <div class="profile-row">
                <div class="profile-label">Email</div>
                <div class="profile-value" id="displayEmail">-</div>
              </div>
              <div class="profile-row">
                <div class="profile-label">No. WhatsApp</div>
                <div class="profile-value" id="displayNoTelp">-</div>
              </div>
            </div>
          </div>

          <div id="tab-address" class="tab-content">
            <div class="dashboard-header">
              <h2>Alamat Saya</h2>
              <button
                type="button"
                class="btn-primary"
                onclick="openAddressModal()"
              >
                <i class="fas fa-plus"></i> Tambah Alamat
              </button>
            </div>
            <div class="address-list" id="addressList"></div>
          </div>

          <div id="tab-history" class="tab-content">
            <div class="dashboard-header">
              <h2>Riwayat Pesanan</h2>
              <p style="color: #666">
                Daftar transaksi yang pernah Anda lakukan.
              </p>
            </div>

            <div id="history-container"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Edit Profil -->
    <div id="editProfileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Profil</h3>
          <button class="close-btn" onclick="closeModal('editProfileModal')">
            &times;
          </button>
        </div>
        <form id="editProfileForm">
          <div class="form-group">
            <label>Nama Depan</label>
            <input
              type="text"
              id="editNamaDepan"
              placeholder="Nama depan"
              required
            />
          </div>
          <div class="form-group">
            <label>Nama Belakang</label>
            <input
              type="text"
              id="editNamaBelakang"
              placeholder="Nama belakang"
            />
          </div>
          <div class="form-group">
            <label>No. WhatsApp</label>
            <input
              type="tel"
              id="editNoTelp"
              placeholder="08xxxxxxxxxx"
              required
            />
          </div>
          <div class="form-group">
            <label>Alamat Lengkap</label>
            <textarea
              id="editAlamat"
              placeholder="Jl., No., RT/RW, Kecamatan, Kabupaten"
              required
              style="min-height: 80px"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn-cancel"
              onclick="closeModal('editProfileModal')"
            >
              Batal
            </button>
            <button
              type="button"
              class="btn-submit"
              onclick="saveEditProfile()"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL: Tambah/Edit Alamat -->
    <div id="addressModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="addressModalTitle">Tambah Alamat Baru</h3>
          <button class="close-btn" onclick="closeModal('addressModal')">
            &times;
          </button>
        </div>
        <form id="addressForm">
          <input type="hidden" id="addressId" />
          <div class="form-group">
            <label>Nama Penerima</label>
            <input
              type="text"
              id="addrNama"
              placeholder="Nama penerima"
              required
            />
          </div>
          <div class="form-group">
            <label>No. Telepon</label>
            <input
              type="tel"
              id="addrTelp"
              placeholder="08xxxxxxxxxx"
              required
            />
          </div>
          <div class="form-group">
            <label>Alamat Lengkap</label>
            <textarea
              id="addrText"
              placeholder="Jl., No., RT/RW, Kecamatan, Kabupaten"
              required
              style="min-height: 100px"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn-cancel"
              onclick="closeModal('addressModal')"
            >
              Batal
            </button>
            <button type="button" class="btn-submit" onclick="saveAddress()">
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // ========== DATA PROFIL USER ==========
      let currentUser = null;

      // 1. Load User & Profil saat halaman dibuka
      async function loadUserProfile() {
        try {
          const userSession = sessionStorage.getItem("user");
          const userLocal = localStorage.getItem("user");
          const userData = JSON.parse(userSession || userLocal || "{}");

          if (!userData.idUser && !userData.id) {
            alert("Anda harus login terlebih dahulu");
            window.location.href = "login.html";
            return;
          }

          currentUser = userData;
          const idUser = userData.idUser || userData.id;

          // Update user greeting
          document.querySelector(".user-card h4").innerText = `Halo, ${
            userData.username || "User"
          }!`;

          // Fetch profil customer dari API
          try {
            const response = await fetch(`/api/users/${idUser}`);
            const result = await response.json();

            if (result.success && result.data) {
              const profil = result.data;
              // Display data
              document.getElementById("displayNamaDepan").innerText =
                profil.namaDepan || "-";
              document.getElementById("displayNamaBelakang").innerText =
                profil.namaBelakang || "-";
              document.getElementById("displayNoTelp").innerText =
                profil.no_telp || "-";
              document.getElementById("displayEmail").innerText =
                userData.email || "-";
            }
          } catch (e) {
            document.getElementById("displayEmail").innerText =
              userData.email || "-";
          }

          // Load alamat tersimpan
          loadAddresses(idUser);

          // Load riwayat pesanan dari database
          loadOrderHistory(idUser);
        } catch (error) {
          console.error("Error loading profile:", error);
          alert("Gagal memuat profil");
        }
      }

      // 2. Load addresses untuk tab "Alamat Saya"
      async function loadAddresses(idUser) {
        try {
          const response = await fetch(`/api/users/${idUser}/addresses`);
          const result = await response.json();

          const addressList = document.getElementById("addressList");

          if (result.success && result.data && result.data.length > 0) {
            addressList.innerHTML = result.data
              .map(
                (addr, idx) => `
                        <div class="address-card">
                            <div class="address-header">
                                <div>
                                    <span class="address-label">${
                                      addr.labelAlamat || "Alamat " + (idx + 1)
                                    }</span>
                                    <div style="margin-top: 8px; font-weight: 600; color: #333;">${
                                      addr.namaPenerima
                                    }</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="btn-small btn-edit" onclick="editAddress(${
                                      addr.idAlamat
                                    })">Edit</button>
                                    <button type="button" class="btn-small btn-delete" onclick="deleteAddress(${
                                      addr.idAlamat
                                    })">Hapus</button>
                                </div>
                            </div>
                            <div class="address-text">
                                <div><i class="fas fa-phone"></i> ${
                                  addr.noTelp
                                }</div>
                                <div style="margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${
                                  addr.alamat
                                }</div>
                            </div>
                        </div>
                    `
              )
              .join("");
          } else {
            addressList.innerHTML =
              '<p style="text-align: center; color: #999; padding: 30px;">Belum ada alamat tersimpan. <a href="#" onclick="openAddressModal(); return false;" style="color: var(--primary-red); font-weight: 600;">Tambah Alamat</a></p>';
          }
        } catch (error) {
          console.error("Error loading addresses:", error);
        }
      }

      // 3. Modal Functions
      function openEditModal() {
        document.getElementById("editNamaDepan").value =
          document.getElementById("displayNamaDepan").innerText;
        document.getElementById("editNamaBelakang").value =
          document.getElementById("displayNamaBelakang").innerText;
        document.getElementById("editNoTelp").value =
          document.getElementById("displayNoTelp").innerText;
        // Fetch alamat dari database untuk prefill
        const idUser = currentUser.idUser || currentUser.id;
        fetch(`/api/users/${idUser}`)
          .then((r) => r.json())
          .then((result) => {
            if (result.success && result.data) {
              document.getElementById("editAlamat").value =
                result.data.alamat || "";
            }
          });
        document.getElementById("editProfileModal").classList.add("show");
      }

      function openAddressModal() {
        document.getElementById("addressId").value = "";
        document.getElementById("addressForm").reset();
        document.getElementById("addressModalTitle").innerText =
          "Tambah Alamat Baru";
        document.getElementById("addressModal").classList.add("show");
      }

      function editAddress(idAlamat) {
        // Fetch address data
        fetch(
          `/api/users/${
            currentUser.idUser || currentUser.id
          }/addresses/${idAlamat}`
        )
          .then((r) => r.json())
          .then((result) => {
            if (result.success) {
              const addr = result.data;
              document.getElementById("addressId").value = addr.idAlamat;
              document.getElementById("addrNama").value = addr.namaPenerima;
              document.getElementById("addrTelp").value = addr.noTelp;
              document.getElementById("addrText").value = addr.alamat;
              document.getElementById("addressModalTitle").innerText =
                "Edit Alamat";
              document.getElementById("addressModal").classList.add("show");
            }
          });
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("show");
      }

      // 4. Save Profile
      async function saveEditProfile() {
        const idUser = currentUser.idUser || currentUser.id;
        const namaDepan = document.getElementById("editNamaDepan").value.trim();
        const namaBelakang = document
          .getElementById("editNamaBelakang")
          .value.trim();
        const noTelp = document.getElementById("editNoTelp").value.trim();
        const alamat = document.getElementById("editAlamat").value.trim();

        if (!namaDepan || !noTelp || !alamat) {
          alert("Nama depan, nomor telp, dan alamat wajib diisi");
          return;
        }

        try {
          const response = await fetch(`/api/users/${idUser}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              namaDepan,
              namaBelakang: namaBelakang || "-",
              no_telp: noTelp,
              alamat,
            }),
          });

          const result = await response.json();
          if (result.success) {
            alert("✓ Profil berhasil diperbarui!");
            closeModal("editProfileModal");
            loadUserProfile();
          } else {
            alert("❌ Gagal: " + result.message);
          }
        } catch (error) {
          alert("❌ Terjadi kesalahan: " + error.message);
        }
      }

      // 5. Save Address
      async function saveAddress() {
        const idUser = currentUser.idUser || currentUser.id;
        const addressId = document.getElementById("addressId").value;
        const nama = document.getElementById("addrNama").value.trim();
        const telp = document.getElementById("addrTelp").value.trim();
        const alamat = document.getElementById("addrText").value.trim();

        if (!nama || !telp || !alamat) {
          alert("Semua field wajib diisi");
          return;
        }

        try {
          const url = addressId
            ? `/api/users/${idUser}/addresses/${addressId}`
            : `/api/users/${idUser}/addresses`;
          const method = addressId ? "PUT" : "POST";

          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ namaPenerima: nama, noTelp: telp, alamat }),
          });

          const result = await response.json();
          if (result.success) {
            alert("✓ Alamat berhasil disimpan!");
            closeModal("addressModal");
            loadAddresses(idUser);
          } else {
            alert("❌ Gagal: " + result.message);
          }
        } catch (error) {
          alert("❌ Terjadi kesalahan: " + error.message);
        }
      }

      // 6. Delete Address
      async function deleteAddress(idAlamat) {
        if (!confirm("Yakin ingin menghapus alamat ini?")) return;

        const idUser = currentUser.idUser || currentUser.id;
        try {
          const response = await fetch(
            `/api/users/${idUser}/addresses/${idAlamat}`,
            {
              method: "DELETE",
            }
          );

          const result = await response.json();
          if (result.success) {
            alert("✓ Alamat berhasil dihapus!");
            loadAddresses(idUser);
          } else {
            alert("❌ Gagal: " + result.message);
          }
        } catch (error) {
          alert("❌ Terjadi kesalahan: " + error.message);
        }
      }

      // 7. Fungsi Ganti Tab
      function switchTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-menu a")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("tab-" + tabName).classList.add("active");
        document.getElementById("menu-" + tabName).classList.add("active");
      }

      // ========== RIWAYAT PESANAN ==========
      async function loadOrderHistory(idUser) {
        const historyContainer = document.getElementById("tab-history");
        try {
          const response = await fetch(`/api/orders?userId=${idUser}`);
          const result = await response.json();

          if (result.success && result.data && result.data.length > 0) {
            const orders = result.data;
            let historyHtml =
              '<div class="dashboard-header"><h2>Riwayat Pesanan</h2></div>';

            orders.forEach((order) => {
              const statusClass =
                order.Status === "Sukses"
                  ? "status-success"
                  : order.Status === "Dibatalkan"
                  ? "status-danger"
                  : "status-pending";
              const formattedDate = new Date(
                order.tanggalPesan
              ).toLocaleDateString("id-ID");

              let itemsHtml = "";
              const items =
                typeof order.items === "string"
                  ? JSON.parse(order.items)
                  : order.items;
              if (items && items.length > 0) {
                items.forEach((item) => {
                  if (item) {
                    itemsHtml += `<div class="h-item"><span>${
                      item.qtyPesanan
                    }x ${item.namaProduk || "Produk"}</span><span>Rp ${(
                      item.subtotal || 0
                    ).toLocaleString("id-ID")}</span></div>`;
                  }
                });
              }

              historyHtml += `
                            <div class="history-card">
                                <div class="history-header">
                                    <div>
                                        <div class="order-id">ID: ${
                                          order.idPemesanan
                                        }</div>
                                        <div class="order-date"><i class="far fa-calendar-alt"></i> ${formattedDate}</div>
                                    </div>
                                    <span class="status-badge ${statusClass}">${
                order.Status
              }</span>
                                </div>
                                <div class="history-items">
                                    ${itemsHtml}
                                </div>
                                <div class="history-footer">
                                    <span class="total-label">Total Tagihan</span>
                                    <span class="total-price">Rp ${(
                                      order.grandTotal || 0
                                    ).toLocaleString("id-ID")}</span>
                                </div>
                            </div>
                        `;
            });
            historyContainer.innerHTML = historyHtml;
          } else {
            historyContainer.innerHTML = `
                        <div class="dashboard-header"><h2>Riwayat Pesanan</h2></div>
                        <div style="text-align:center; padding: 40px; color:#888;">
                            <i class="fas fa-shopping-bag" style="font-size: 3rem; margin-bottom:15px; opacity:0.3;"></i>
                            <p>Belum ada riwayat pesanan.</p>
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Error loading order history:", error);
          historyContainer.innerHTML = `
                    <div class="dashboard-header"><h2>Riwayat Pesanan</h2></div>
                    <div style="text-align:center; padding: 40px; color:#888;">
                        <p>Gagal memuat riwayat pesanan</p>
                    </div>
                `;
        }
      }

      // Load profile saat halaman terbuka
      document.addEventListener("DOMContentLoaded", loadUserProfile);

      // Close modal saat klik di luar
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.classList.remove("show");
        }
      };
    </script>
  </body>
</html>
